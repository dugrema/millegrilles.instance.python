(this["webpackJsonpmonitor.web"]=this["webpackJsonpmonitor.web"]||[]).push([[0],{151:function(e,t){},237:function(e){e.exports=JSON.parse('{"translation":{"global":{"dateHeure":"{{date, YYYY-MM-DD HH:mm:ss}}","dateModifiee":"{{date, D MMM}}","dateAnneeModifiee":"{{date, D MMM YYYY}}","heureModifiee":"{{date, HH:mm}}","securite":{"secure":"S\xe9cure","protege":"Prot\xe9g\xe9","prive":"Priv\xe9","public":"Public"},"appliquer":"Appliquer","sauvegarder":"Sauvegarder","publier":"Publier","retour":"Retour","ajouter":"Ajouter","supprimer":"Supprimer","url":"URL","rafraichir":"Rafraichir","activer":"Activer","desactiver":"Desactiver"},"application":{"nom":"MilleGrilles","advert":"MilleGrilles","version":"v.{{version}}"},"menu":{"vitrine":"Vitrine","applications":"Applications","posteur":"Posteur","coupdoeil":"Coup D\'Oeil","changerLangue":"English","nonDisponible":"Veuillez vous authentifier"},"authentification":{"accesProprietaire":"Acc\xe8s prot\xe9g\xe9 pour le propri\xe9taire avec une cl\xe9 de s\xe9curit\xe9","accesPrive":"Acc\xe8s priv\xe9 pour les usagers de la MilleGrille"},"bouton":{"accesProprietaire":"Acc\xe8s propri\xe9taire","annuler":"Annuler","suivant":"Suivant","pki":"Pki"},"backup":{"cles":{"titre":"Backup cl\xe9 racine","instructions_1":"Faire une copie des cl\xe9s priv\xe9es de la MilleGrille.","instructions_2":"Ces cl\xe9s sont requises pour permettre une restauration compl\xe8te de la MilleGrille.","instructions_3":"Le mot de passe doit \xeatre rang\xe9 dans un endroit diff\xe9rent de celui des cl\xe9s. Par exemple, le mot de passe peut \xeatre sauvegard\xe9 dans un gestionnaire de mots de passe (e.g. SplashID) ou imprim\xe9 et rang\xe9 dans votre porte-feuille.","avertissementTitre":"Avertissement","avertissement_1":"Si une cl\xe9 et son mot de passe est vol\xe9, la MilleGrille doit \xeatre d\xe9truite aussi vite que possible.","avertissement_2":"Les cl\xe9s ne doivent sous aucun pr\xe9texte \xeatre donn\xe9es \xe0 quelqu\'un d\'autre, surtout si ce n\'est pas quelqu\'un \xe0 qui vous seriez pr\xeat \xe0 donner une copie des cl\xe9s de votre voiture sport.","motDePasse":"Mot de passe : ","boutonGenerer":"G\xe9n\xe9rer","boutonRecupererCleRacine":"Charger cl\xe9 racine","boutonGenererCleBackup":"G\xe9n\xe9rer cl\xe9 de backup"}}}}')},238:function(e){e.exports=JSON.parse('{"translation":{}}')},246:function(e,t,r){},247:function(e,t,r){},301:function(e,t){},333:function(e,t,r){},354:function(e,t){},356:function(e,t){},371:function(e,t,r){"use strict";r.r(t);var n=r(0),a=r.n(n),i=r(44),c=r.n(i),s=(r(246),r(9)),o=(r(247),r(11)),l=r(8),u=r(15),d=r(19),j=r(78),p=r.n(j),b=r(34),h=r(79),f=r(63),O=r(105),m=r(376),g=r(375),x=r(241),v=r(1);function C(e){return Object(v.jsxs)(g.a,{collapseOnSelect:!0,expand:"md",bg:"info",variant:"dark",fixed:"top",children:[Object(v.jsx)(x.a.Link,{className:"navbar-brand",onClick:e.changerPage,eventKey:"Accueil",children:Object(v.jsx)(m.a,{children:"application.nom"})}),Object(v.jsx)(g.a.Toggle,{"aria-controls":"responsive-navbar-menu"}),Object(v.jsxs)(g.a.Collapse,{id:"responsive-navbar-menu",children:[Object(v.jsx)(x.a,{children:Object(v.jsx)(x.a.Link,{href:"/"})}),Object(v.jsx)(x.a,{className:"mr-auto"}),Object(v.jsx)(x.a,{className:"justify-content-end",children:Object(v.jsx)(x.a.Link,{onClick:e.rootProps.changerLanguage,children:Object(v.jsx)(m.a,{children:"menu.changerLangue"})})})]})]})}r(333);function P(e){return Object(v.jsxs)("div",{className:"flex-wrapper",children:[Object(v.jsxs)("div",{children:[Object(v.jsx)(k,{changerPage:e.changerPage,rootProps:e.rootProps}),Object(v.jsx)(S,{changerPage:e.changerPage,page:e.page})]}),Object(v.jsx)(y,{rootProps:e.rootProps})]})}function k(e){return Object(v.jsxs)(O.a,{children:[Object(v.jsx)(C,{changerPage:e.changerPage,rootProps:e.rootProps}),Object(v.jsx)("h1",{children:"MilleGrilles"})]})}function S(e){return Object(v.jsx)(O.a,{children:e.page})}function y(e){var t=e.rootProps.idmg,r=null;return e.rootProps.idmg&&(r=Object(v.jsx)(p.a,{value:"idmg:"+t,size:75})),Object(v.jsx)(O.a,{fluid:!0,className:"footer bg-info",children:Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:2,className:"footer-left"}),Object(v.jsx)(l.a,{sm:8,className:"footer-center",children:Object(v.jsxs)("div",{className:"millegrille-footer",children:[Object(v.jsxs)("div",{children:["IDMG : ",t]}),Object(v.jsxs)("div",{children:[Object(v.jsx)(m.a,{children:"application.advert"})," ",Object(v.jsx)("span",{title:e.rootProps.manifest.date,children:Object(v.jsx)(m.a,{values:{version:e.rootProps.manifest.version},children:"application.version"})})]})]})}),Object(v.jsx)(l.a,{sm:2,className:"footer-right",children:r})]})})}var w=r(2),N=r(13),D=r(14),I=r(22),A=r(24),M=r(27),T=r.n(M),E=r(96),R=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={afficherAide:!1},e.fermerAide=function(t){e.setState({afficherAide:!1})},e}return Object(D.a)(r,[{key:"render",value:function(){var e=this,t=Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)(u.a,{onClick:function(t){e.setState({afficherAide:!0})},children:Object(v.jsx)("i",{className:"fa fa-question-circle"})})})});return this.state.afficherAide&&(t=Object(v.jsx)(G,{fermer:this.fermerAide})),Object(v.jsxs)(O.a,{children:[Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)("h3",{children:"Configurer le nouveau noeud"}),"Nouveau noeud de MilleGrille. Veuillez suivre les etapes pour demarrer votre noeud."]})}),t,Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)("h3",{children:"Type de noeud"})})}),Object(v.jsx)(F,Object(w.a)({},this.props))]})}}]),r}(a.a.Component);function G(e){return Object(v.jsxs)(d.a,{variant:"info",onClose:e.fermer,dismissible:!0,children:[Object(v.jsx)(d.a.Heading,{children:"Information sur les types de noeud"}),Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{md:2,children:"Protege"}),Object(v.jsx)(l.a,{md:10,children:"Noeud central de la MilleGrille. Contient une base de donnees, un systeme de messagerie et un certificat special lui permettant d'autoriser les autres composants systeme. Le noeud protege supporte toutes les fonctionnalites protegees, privees et publiques."})]}),Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{md:2,children:"Prive"}),Object(v.jsx)(l.a,{md:10,children:"Noeud additionnel qui supporte des services et des applications (senseurs, backup, etc.). Doit etre associe a un noeud protege. Peut aussi agir comme noeud public s'il est configure avec acces a internet."})]}),Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{md:2,children:"Public"}),Object(v.jsx)(l.a,{md:10,children:"Noeud specialise pour la publication et dissemination sur internet. Doit etre associe a un noeud protege. Ce noeud doit aussi etre configure avec un acces internet (adresse DNS, ports ouverts sur le routeur)."})]})]})}function F(e){return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)(E.a,{children:Object(v.jsx)("fieldset",{children:Object(v.jsxs)(E.a.Group,{children:[Object(v.jsxs)(E.a.Check,{id:"typenoeud-protege",children:[Object(v.jsx)(E.a.Check.Input,{type:"radio",name:"type-noeud",value:"protege",onChange:e.setTypeNoeud}),Object(v.jsx)(E.a.Check.Label,{children:"Protege"})]}),Object(v.jsxs)(E.a.Check,{id:"typenoeud-prive",children:[Object(v.jsx)(E.a.Check.Input,{type:"radio",name:"type-noeud",value:"prive",onChange:e.setTypeNoeud}),Object(v.jsx)(E.a.Check.Label,{children:"Prive"})]}),Object(v.jsxs)(E.a.Check,{id:"typenoeud-public",children:[Object(v.jsx)(E.a.Check.Input,{type:"radio",name:"type-noeud",value:"public",onChange:e.setTypeNoeud}),Object(v.jsx)(E.a.Check.Label,{children:"Public"})]})]})})}),Object(v.jsx)(o.a,{className:"boutons-installer",children:Object(v.jsx)(l.a,{children:Object(v.jsx)(u.a,{onClick:e.afficherPageTypeInstallation,value:"true",disabled:!e.typeNoeud,children:"Suivant"})})})]})}var L=r(5),q=r(18),_=r(10),U=r(240),Q=r(72);h.b.chargerClePrivee;function W(e,t,r){return H.apply(this,arguments)}function H(){return(H=Object(q.a)(Object(L.a)().mark((function e(t,r,n){var a,i;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(Q.chargerPemClePriveeEd25519)(r,{password:n}),e.next=3,Object(f.encoderIdmg)(t);case 3:return i=e.sent,console.debug("IDMG calcule : %s",i),e.abrupt("return",{idmg:i,clePrivee:a});case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function B(e,t){return z.apply(this,arguments)}function z(){return(z=Object(q.a)(Object(L.a)().mark((function e(t,r){var n,a,i;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.certificat,a=r.clePrivee,e.next=3,Object(Q.genererCertificatIntermediaire)(t,n,a);case 3:return i=e.sent,e.abrupt("return",i);case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function V(e){return Y.apply(this,arguments)}function Y(){return(Y=Object(q.a)(Object(L.a)().mark((function e(t){return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",b.pki.certificateFromPem(t));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function J(){return(J=Object(q.a)(Object(L.a)().mark((function e(){var t,r,n,a,i,c,s,o,l;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(Q.genererPassword)(),e.next=3,Object(Q.genererClePrivee)({password:t,dechiffre:!0});case 3:return r=e.sent,n=r.pem,a=r.pemChiffre,i=r.publicKey,c=r.privateKey,console.debug("Public Key : %O",i),console.debug("Private Key : %O",c),console.debug("PEM prive : %s","\n"+n),console.debug("PEM chiffre : %s","\n"+a),e.next=14,Object(Q.genererCertificatMilleGrille)(n);case 14:return s=e.sent,o=s.idmg,l=s.pem,console.debug("Nouveau certificat CA\n%s",l),e.abrupt("return",{idmg:o,certPem:l,clePriveePem:a,motdepasseCle:t});case 19:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var K=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={certificat:"",motdepasse:"",cleChiffree:"",afficherErreur:!1,erreurChargement:"",clePriveeChargee:!1,modeScanQR:!1,videoinput:!1,resultatScan:"",partiesDeCle:{},nombrePartiesDeCle:"",nombrePartiesDeCleScannees:0,partiesDeCertificat:{},nombrePartiesDeCertificatTotal:"",nombrePartiesDeCertificatScannes:0},e.changerChamp=function(t){var r=t.currentTarget,n=r.name,a=r.value;e.setState(Object(_.a)({},n,a),function(){var t=Object(q.a)(Object(L.a)().mark((function t(r){return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:console.debug("State : %O",e.state);case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},e.recevoirFichiers=function(){var t=Object(q.a)(Object(L.a)().mark((function t(r){var n,a,i,c;return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,X(r);case 2:if(n=t.sent,console.debug("Resultats upload : %O",n),!(n.length>0)){t.next=10;break}if(a=n[0],i=a.racine.cleChiffree,c=a.racine.certificat,!i||!c){t.next=10;break}return t.next=10,new Promise((function(t,r){e.setState({cleChiffree:i,certificat:c},(function(r){e.chargerCle(),t()}))}));case 10:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.activerScanQr=function(t){e.setState({modeScanQR:!0})},e.fermerScanQr=function(t){e.setState({modeScanQR:!1})},e.erreurScanQr=function(t){console.error("Erreur scan QR: %O",t),e.fermerScanQr()},e.handleScan=function(){var t=Object(q.a)(Object(L.a)().mark((function t(r){var n,a,i,c,s,o,l,u,d,j,p;return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!r){t.next=22;break}return t.next=3,new Promise((function(t,n){e.setState({resultatScan:r},(function(e){t()}))}));case 3:if(1!==(n=r.split("\n")).length){t.next=8;break}e.setState({motdepasse:r},(function(t){e.chargerCle()})),t.next=20;break;case 8:if(2!==n.length){t.next=20;break}if(3!==(a=n[0].split(";")).length){t.next=20;break}if(i=a[0],c=a[1],s=Number(a[2]),"racine.cle"!==i){t.next=19;break}return o=Object(w.a)(Object(w.a)({},e.state.partiesDeCle),{},Object(_.a)({},c,n[1])),l=Object.keys(o).length,t.next=17,new Promise((function(t,r){e.setState({partiesDeCle:o,nombrePartiesDeCle:s,nombrePartiesDeCleScannees:l},(function(e){t()}))}));case 17:t.next=20;break;case 19:"racine.cert"===i&&(u=Object(w.a)(Object(w.a)({},e.state.partiesDeCertificat),{},Object(_.a)({},c,n[1])),d=Object.keys(u).length,e.setState({partiesDeCertificat:u,nombrePartiesDeCertificatTotal:s,nombrePartiesDeCertificatScannes:d}));case 20:e.state.nombrePartiesDeCle===e.state.nombrePartiesDeCleScannees&&(j=re(e.state.partiesDeCle),e.setState({cleChiffree:j},(function(t){e.chargerCle()}))),e.state.nombrePartiesDeCertificatTotal===e.state.nombrePartiesDeCertificatScannes&&(p=ne(e.state.partiesDeCertificat),e.setState({certificat:p},(function(t){e.chargerCle()})));case 22:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.cacherErreurChargement=function(t){e.setState({afficherErreur:!1})},e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){var e=this;Object(h.a)().then((function(t){console.debug("Apps detectees : %O",t),e.setState(Object(w.a)({},t))}))}},{key:"chargerCle",value:function(){var e=Object(q.a)(Object(L.a)().mark((function e(){var t;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.state.certificat&&this.state.motdepasse&&this.state.cleChiffree)){e.next=16;break}return e.prev=1,console.debug("State chargeCle : %O",this.state),e.next=5,W(this.state.certificat,this.state.cleChiffree,this.state.motdepasse);case 5:t=e.sent,console.debug("Chargement cert, cles : %O",t),t?(this.setState({clePriveeChargee:!0,motdepasse:"",cleChiffree:""}),this.fermerScanQr(),this.props.rootProps.setInfoClecertMillegrille(Object(w.a)(Object(w.a)({},t),{},{certificat:this.state.certificat})),console.debug("Root props avec info cle : %O",this.props.rootProps),this.traiterCsr()):this.setState({clePriveeChargee:!1,afficherErreur:!0}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(1),console.error("Erreur chargement cle\n%O",e.t0),this.setState({erreurChargement:e.t0,afficherErreur:!0});case 14:e.next=17;break;case 16:console.debug("Cle, cert pas pret : %O",this.state);case 17:case"end":return e.stop()}}),e,this,[[1,10]])})));return function(){return e.apply(this,arguments)}}()},{key:"traiterCsr",value:function(){var e=Object(q.a)(Object(L.a)().mark((function e(){var t,r,n,a,i;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.props.csr){e.next=7;break}return r=this.props.urlCsr||"/installation/api/csr",e.next=5,T.a.get(r);case 5:n=e.sent,t=n.data;case 7:return e.next=9,B(t,this.props.rootProps.infoClecertMillegrille);case 9:return a=e.sent,e.next=12,V(a);case 12:i=e.sent,this.setState({certificatintermediairePem:a,certificatintermediaireCert:i}),this.props.rootProps.setInfoCertificatNoeudProtege(a,i);case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.props.cacherBoutons;if(this.state.modeScanQR)return Object(v.jsx)(te,{fermer:this.fermerScanQr,resultatScan:this.state.resultatScan,handleError:this.erreurScanQr,handleScan:this.handleScan,nombrePartiesDeCleTotal:this.state.nombrePartiesDeCle,nombrePartiesDeCleScannees:this.state.nombrePartiesDeCleScannees,nombrePartiesDeCertificatTotal:this.state.nombrePartiesDeCertificatTotal,nombrePartiesDeCertificatScannes:this.state.nombrePartiesDeCertificatScannes,motdepasse:this.state.motdepasse});var t="",r=this.props.rootProps.intermediaireCert;return t=this.state.clePriveeChargee&&r?Object(v.jsxs)(d.a,{variant:"success",children:[Object(v.jsx)(d.a.Heading,{children:"Cle prete"}),Object(v.jsx)("p",{children:"Certificat et cle de MilleGrille charges correctement."}),Object(v.jsxs)("p",{children:["IDMG charge : ",this.props.rootProps.idmg]}),Object(v.jsxs)("p",{children:["Certificat intermediaire genere pour le noeud protege :"," ",r.subject.getField("CN").value]})]}):Object(v.jsx)(Z,{motdepasse:this.state.motdepasse,changerChamp:this.changerChamp,recevoirFichiers:this.recevoirFichiers,videoinput:this.state.videoinput,activerScanQr:this.activerScanQr,setPage:this.props.setPage,afficherErreur:this.state.afficherErreur,erreurChargement:this.state.erreurChargement,cacherErreurChargement:this.cacherErreurChargement,existantSeulement:e}),Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)("h3",{children:"Certificat et cle privee de MilleGrille"})})}),t,!0!==e?Object(v.jsx)(o.a,{className:"boutons-installer",children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)(u.a,{onClick:this.props.setPage,value:"PageConfigurationInternet",disabled:!this.state.clePriveeChargee,children:"Suivant"}),Object(v.jsx)(u.a,{onClick:this.props.setPage,value:"SelectionnerTypeNoeud",variant:"secondary",children:"Retour"})]})}):""]})}}]),r}(a.a.Component);function Z(e){var t="";return e.afficherErreur&&(t=Object(v.jsxs)(d.a,{variant:"danger",onClose:e.cacherErreurChargement,dismissible:!0,children:[Object(v.jsx)(d.a.Heading,{children:"Cle invalide"}),Object(v.jsx)("p",{children:""+e.erreurChargement})]})),e.existantSeulement?Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[t,Object(v.jsx)($,Object(w.a)({},e))]})}):Object(v.jsxs)(o.a,{children:[Object(v.jsxs)(l.a,{md:5,children:[Object(v.jsx)("h4",{children:"Creer une nouvelle MilleGrille"}),Object(v.jsx)(u.a,{variant:"secondary",onClick:e.setPage,value:"GenererNouvelleCle",children:"Nouvelle"})]}),Object(v.jsxs)(l.a,{md:2,children:[Object(v.jsx)("p",{children:"|"}),Object(v.jsx)("p",{children:"OU"}),Object(v.jsx)("p",{children:"|"})]}),Object(v.jsxs)(l.a,{md:5,children:[t,Object(v.jsx)($,Object(w.a)({},e))]})]})}function $(e){var t="";return e.videoinput&&(t=Object(v.jsx)(u.a,{variant:"secondary",onClick:e.activerScanQr,children:"QR Scan"})),Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h4",{children:"Importer certificat et cle existants"}),Object(v.jsxs)(E.a.Group,{controlId:"formMotdepasse",children:[Object(v.jsx)(E.a.Label,{children:"Mot de passe de cle"}),Object(v.jsx)(E.a.Control,{type:"text",name:"motdepasse",value:e.motdepasse,autoComplete:"false",onChange:e.changerChamp,placeholder:"AAAA-bbbb-1111-2222"})]}),Object(v.jsxs)(o.a,{children:[Object(v.jsxs)(l.a,{children:[Object(v.jsx)(U.a,{onDrop:e.recevoirFichiers,children:function(e){var t=e.getRootProps,r=e.getInputProps;return Object(v.jsx)("span",{className:"uploadIcon btn btn-secondary",children:Object(v.jsxs)("span",Object(w.a)(Object(w.a)({},t()),{},{children:[Object(v.jsx)("input",Object(w.a)({},r())),Object(v.jsx)("span",{className:"fa fa-upload fa-2x"})]}))})}}),t]}),Object(v.jsx)(l.a,{})]})]})}function X(e){return ee.apply(this,arguments)}function ee(){return ee=Object(q.a)(Object(L.a)().mark((function e(t){var r;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(t.map(function(){var e=Object(q.a)(Object(L.a)().mark((function e(t){var r,n,a;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("application/json"!==t.type){e.next=8;break}return r=new FileReader,e.next=4,new Promise((function(e,n){r.onload=function(){var t=r.result,n=String.fromCharCode.apply(null,new Uint8Array(t));e({contenuFichier:n})},r.onerror=function(e){n(e)},r.readAsArrayBuffer(t)}));case 4:return n=e.sent,console.debug(n),a=JSON.parse(n.contenuFichier),e.abrupt("return",a);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e)}))),ee.apply(this,arguments)}function te(e){return Object(v.jsx)("p",{children:"Fix me"})}function re(e){for(var t="",r=Object.keys(e).length,n=1;n<=r;n++)t+=e[""+n];return t="-----BEGIN ENCRYPTED PRIVATE KEY-----\n"+t+"\n-----END ENCRYPTED PRIVATE KEY-----\n"}function ne(e){for(var t="",r=Object.keys(e).length,n=1;n<=r;n++)t+=e[""+n];return t="-----BEGIN CERTIFICATE-----\n"+t+"\n-----END CERTIFICATE-----\n"}function ae(e){return e.certificat?Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsxs)("p",{children:["IDMG : ",e.certificat.subject.getField("O").value]}),Object(v.jsxs)("p",{children:["Noeud : ",e.certificat.subject.getField("CN").value]})]})}):""}var ie=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){return Object(N.a)(this,r),t.apply(this,arguments)}return Object(D.a)(r,[{key:"render",value:function(){var e=[];if(this.props.pem){var t=this.props.pem.trim().split("\n");t[0].startsWith("---")&&(t=t.slice(1));var r=t.length-1;t[r].startsWith("---")&&(t=t.slice(0,r));for(var n=t.join(""),a=Math.ceil(n.length/800),i=n.length/a+a,c=0;c<a;c++){var s=c*i,u=(c+1)*i;u>n.length&&(u=n.length);var d=n.slice(s,u);d=this.props.nom+";"+(c+1)+";"+a+"\n"+d,e.push(Object(v.jsx)(l.a,{xs:6,className:"qr-code",children:Object(v.jsx)(p.a,{className:"qrcode",value:d,size:300})},c))}}return Object(v.jsx)(o.a,{children:e})}}]),r}(a.a.Component);function ce(e){var t=null,r=null;return e.certificat&&(t=Object(v.jsxs)("div",{className:"pem",children:[Object(v.jsx)("p",{children:"Certificat"}),Object(v.jsx)(ie,{pem:e.certificat,nom:e.nom+".cert"})]})),e.clePrivee&&(r=Object(v.jsxs)("div",{className:"cle-pem",children:[Object(v.jsx)("p",{children:e.idmg}),Object(v.jsx)(d.a,{variant:"warning",children:"Conserver cette page separement de celle avec le mot de passe."}),Object(v.jsx)("p",{children:"Cle chiffree de la MilleGrille"}),Object(v.jsx)(ie,{pem:e.clePrivee,nom:e.nom+".cle"})]})),Object(v.jsxs)("div",{children:[t,r]})}function se(e){return e.certificatRacine&&e.motdepasse&&e.cleChiffreeRacine?Object(v.jsxs)("div",{children:[Object(v.jsxs)(o.a,{className:"motdepasse",children:[Object(v.jsxs)(l.a,{lg:8,children:[Object(v.jsx)(m.a,{children:"backup.cles.motDePasse"}),Object(v.jsx)("p",{children:e.motdepasse})]}),Object(v.jsx)(l.a,{lg:4,children:Object(v.jsx)(p.a,{value:e.motdepasse,size:75})})]}),Object(v.jsx)("div",{className:"print-only",children:Object(v.jsx)(ce,{certificat:e.certificatRacine,clePrivee:e.cleChiffreeRacine,nom:"racine",idmg:e.idmg})})]}):Object(v.jsx)("div",{})}var oe=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={certificatRacinePret:!1,credentialsRacine:"",etapeVerifierCle:!1,etapeGenererIntermediaire:!1,etapeDemarrerInstallation:!1,etapeSurveillerInstallation:!1,idmg:"",backupComplete:!1,certPem:"",clePriveePem:"",motdepasseCle:"",url:""},e.setCertificatMillegrille=function(t){e.setState({certificatMillegrillePem:t})},e.setCertificatIntermediaire=function(t){e.setState({certificatIntermediairePem:t})},e.setBackupFait=function(t){e.setState({backupComplete:!0})},e.imprimer=function(t){window.print(),e.setState({backupComplete:!0})},e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){var e=this;this.state.certificatRacinePret||function(){return J.apply(this,arguments)}().then((function(t){console.debug("Credentials racine : %O",t),e.setState({certificatRacinePret:!0,idmg:t.idmg,certPem:t.certPem,clePriveePem:t.clePriveePem,motdepasseCle:t.motdepasseCle})})).catch((function(e){console.error("Erreur generation nouvelle cle MilleGrille\n%O",e)}))}},{key:"render",value:function(){return Object(v.jsx)(le,Object(w.a)(Object(w.a)({},this.props),{},{setConfigurationEnCours:this.setConfigurationEnCours,imprimer:this.imprimer,setPage:this.props.setPage,certPem:this.state.certPem,clePriveePem:this.state.clePriveePem,motdepasseCle:this.state.motdepasseCle,idmg:this.state.idmg,setBackupFait:this.setBackupFait,backupComplete:this.state.backupComplete}))}}]),r}(a.a.Component);function le(e){var t=null;if(e.idmg){var r=function(e,t,r){var n={idmg:e},a={certificat:t,cleChiffree:r};n.racine=a;var i=JSON.stringify(n),c=new Blob([i],{type:"application/json"});return{dataUrl:window.URL.createObjectURL(c)}}(e.idmg,e.certPem,e.clePriveePem).dataUrl,n="backupCle_"+e.idmg+".json";t=Object(v.jsx)(u.a,{href:r,download:n,onClick:e.setBackupFait,variant:"outline-secondary",children:"Telecharger cle"})}return Object(v.jsxs)(O.a,{children:[Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{className:"screen-only",children:Object(v.jsx)("h2",{children:"Nouvelle cle de MilleGrille"})})}),Object(v.jsxs)(d.a,{variant:"warning",children:[Object(v.jsx)("p",{children:"Le proprietaire de la MilleGrille est le seul qui devrait etre en possession de cette cle."}),Object(v.jsx)("p",{children:"Il ne faut pas perdre ni se faire voler la cle de MilleGrille."})]}),Object(v.jsxs)("div",{children:["IDMG : ",e.idmg]}),Object(v.jsx)(se,{rootProps:e.rootProps,certificatRacine:e.certPem,motdepasse:e.motdepasseCle,cleChiffreeRacine:e.clePriveePem,idmg:e.idmg}),Object(v.jsxs)("div",{className:"bouton",children:[Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:"Utiliser au moins une des deux actions suivantes pour conserver la cle et le certificat de MilleGrille."})}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)(u.a,{onClick:e.imprimer,variant:"outline-secondary",children:"Imprimer"}),t]})}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{className:"boutons-installer",children:[Object(v.jsx)(u.a,{onClick:e.setPage,value:"ChargementClePrivee",disabled:!e.backupComplete,children:"Suivant"}),Object(v.jsx)(u.a,{onClick:e.setPage,value:"",variant:"secondary",children:"Retour"})]})})]})]})}var ue=r(377),de=r(231),je=/^((?!-)[A-Za-z0-9-]{1,63}(?<!-)\.)+[A-Za-z]{2,6}$/,pe=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={internetDisponible:!1,domaine:e.props.fqdnDetecte,domaineValide:je.test(e.props.fqdnDetecte),domainesAdditionnels:"",configurationAvancee:!1,modeTest:!1,modeCreation:"webroot",cloudns_subauthid:"",cloudns_password:"",dnssleep:"240",attenteServeur:!1},e.setInternetDisponible=function(t){console.debug("Set internet disponible : %O",t);var r=t.currentTarget;console.debug("Set internet disponible eventInfo: %O",r),e.setState({internetDisponible:"true"===r.value})},e.changerDomaine=function(t){var r=t.currentTarget.value,n=je.test(r);e.setState({domaine:r,domaineValide:n})},e.changerTextfield=function(t){var r=t.currentTarget,n=r.name,a=r.value;e.setState(Object(_.a)({},n,a))},e.setCheckbox=function(t){var r=t.currentTarget,n=r.name,a=r.checked;e.setState(Object(_.a)({},n,a))},e.setModeCreation=function(t){var r=t.currentTarget.value;e.setState({modeCreation:r},(function(){console.debug("State :\n%O",e.state)}))},e.configurerDomaine=function(t){var r=Object(w.a)({},e.state);r.domainesAdditionnels&&(r.domainesAdditionnels=r.domainesAdditionnels.split(",").map((function(e){return e.trim()}))),e.props.rootProps.setInfoInternet(r),e.props.setPage({currentTarget:{value:"ConfigurerNoeud"}})},e.revenirPageSaisie=function(t){e.setState({attenteServeur:!1})},e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){console.debug("props : %O",this.props)}},{key:"render",value:function(){return Object(v.jsx)(be,{rootProps:this.props.rootProps,domaine:this.state.domaine,domaineValide:this.state.domaineValide,internetDisponible:this.state.internetDisponible,changerDomaine:this.changerDomaine,changerTextfield:this.changerTextfield,setInternetDisponible:this.setInternetDisponible,setCheckbox:this.setCheckbox,configurationAvancee:this.state.configurationAvancee,modeTest:this.state.modeTest,cloudns_subauthid:this.state.cloudns_subauthid,cloudns_password:this.state.cloudns_password,dnssleep:this.state.dnssleep,setModeCreation:this.setModeCreation,modeCreation:this.state.modeCreation,configurerDomaine:this.configurerDomaine})}}]),r}(a.a.Component);function be(e){return Object(v.jsxs)(O.a,{children:[Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)("h3",{children:"Configurer le domaine de la MilleGrille"})})}),Object(v.jsx)(E.a.Group,{children:Object(v.jsxs)(E.a.Check,{id:"installation-internet",children:[Object(v.jsx)(E.a.Check.Input,{type:"checkbox",name:"internet-disponible",value:"true",onChange:e.setInternetDisponible,checked:e.internetDisponible}),Object(v.jsx)(E.a.Check.Label,{children:"Disponible sur internet"})]})}),Object(v.jsx)(he,Object(w.a)({},e)),Object(v.jsx)(o.a,{className:"boutons-installer",children:Object(v.jsx)(l.a,{children:Object(v.jsx)(u.a,{onClick:e.configurerDomaine,value:"true",disabled:!e.domaineValide,children:"Suivant"})})})]})}function he(e){if(!e.internetDisponible)return"";var t="";if(e.configurationAvancee){var r="";"dns_cloudns"===e.modeCreation&&(r=Object(v.jsxs)("div",{children:[Object(v.jsx)("label",{htmlFor:"cloudns-subid",children:"Configuration ClouDNS"}),Object(v.jsxs)(ue.a,{children:[Object(v.jsx)(ue.a.Text,{id:"cloudns-subid",children:"SubID (numero)"}),Object(v.jsx)(de.a,{id:"cloudns-subid","aria-describedby":"cloudns-subid",name:"cloudns_subauthid",value:e.cloudns_subauthid,onChange:e.changerTextfield})]}),Object(v.jsxs)(ue.a,{children:[Object(v.jsx)(ue.a.Text,{id:"cloudns-password",children:"Mot de passe"}),Object(v.jsx)(de.a,{id:"cloudns-password","aria-describedby":"cloudns-password",type:"password",name:"cloudns_password",value:e.cloudns_password,onChange:e.changerTextfield})]}),Object(v.jsxs)(ue.a,{children:[Object(v.jsx)(ue.a.Text,{id:"dns-sleep",children:"DNS sleep"}),Object(v.jsx)(de.a,{id:"dns-sleep","aria-describedby":"dns-sleep",name:"dnssleep",value:e.dnssleep,onChange:e.changerTextfield})]})]})),t=Object(v.jsxs)("div",{children:[Object(v.jsxs)(ue.a,{children:[Object(v.jsx)(ue.a.Text,{id:"domaines-additionnels",children:"Domaines additionnels"}),Object(v.jsx)(de.a,{id:"domaines-additionnels","aria-describedby":"domaines-additionnels",name:"domainesAdditionnels",value:e.domainesAdditionnels,onChange:e.changerTextfield})]}),Object(v.jsxs)(E.a.Check,{id:"certificat-test",children:[Object(v.jsx)(E.a.Check.Input,{type:"checkbox",name:"modeTest",value:"true",onChange:e.setCheckbox,checked:e.modeTest}),Object(v.jsx)(E.a.Check.Label,{children:"Certificat de test"})]}),Object(v.jsxs)(E.a.Group,{controlId:"modeCreationCertificat",children:[Object(v.jsx)(E.a.Label,{children:"Mode de creation certificat"}),Object(v.jsxs)(E.a.Control,{as:"select",value:e.modeCreation,onChange:e.setModeCreation,children:[Object(v.jsx)("option",{value:"webroot",children:"Mode http (port 80)"}),Object(v.jsx)("option",{value:"dns_cloudns",children:"ClouDNS"})]})]}),r]})}return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)("h4",{children:"Configuration prealable"}),Object(v.jsxs)("ul",{children:[Object(v.jsx)("li",{children:"Nom de domaine"}),Object(v.jsx)("li",{children:"Configurer les ports TCP 443 et 80 sur le routeur"})]}),Object(v.jsxs)("p",{children:["Adresse IPv4 detectee pour le noeud : ",e.ipDetectee]})]})}),Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)("h3",{children:"Configuration"})})}),Object(v.jsxs)(E.a,{children:[Object(v.jsxs)("label",{htmlFor:"noeud-url",children:["URL d'acces au noeud ",e.flagDomaineInvalide]}),Object(v.jsxs)(ue.a,{className:"mb-3",children:[Object(v.jsx)(ue.a.Text,{id:"noeud-addon3",children:"https://"}),Object(v.jsx)(de.a,{id:"noeud-url","aria-describedby":"noeud-addon3",value:e.domaine,onChange:e.changerDomaine})]}),Object(v.jsxs)(E.a.Check,{id:"configuration-avancee",children:[Object(v.jsx)(E.a.Check.Input,{type:"checkbox",name:"configurationAvancee",value:"true",onChange:e.setCheckbox,checked:e.configurationAvancee}),Object(v.jsx)(E.a.Check.Label,{children:"Configuration avancee"})]}),t]})]})}var fe=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={err:"",attente:!1},e.redemarrer=function(t){var r=e.props.rootProps.infoCertificatNoeudProtege,n=e.props.rootProps.infoClecertMillegrille,a={certificatPem:r.pem,chainePem:[r.pem,n.certificat],securite:"3.protege"};console.debug("Transmettre parametres d'installation: \n%O",a),T.a.post("/installation/api/initialisation",a).then((function(t){console.debug("Recu reponse demarrage installation noeud\n%O",t),e.setState({attente:!0}),setTimeout((function(e){window.location.reload()}),15e3)})).catch((function(t){console.error("Erreur demarrage installation noeud\n%O",t),e.setState({err:""+t})}))},e}return Object(D.a)(r,[{key:"render",value:function(){var e=Object(v.jsxs)(d.a,{variant:"success",children:[Object(v.jsx)(d.a.Heading,{children:"Configuration prete"}),Object(v.jsx)("p",{children:"La configuration du noeud est prete."}),Object(v.jsx)("p",{children:"Cliquez sur Redemarrer pour lancer l'installation du logiciel."})]});return this.state.err?e=Object(v.jsxs)(d.a,{variant:"danger",children:[Object(v.jsx)(d.a.Heading,{children:"Erreur installation"}),Object(v.jsx)("p",{children:this.state.err})]}):this.state.attente&&(e=Object(v.jsx)(d.a,{variant:"info",children:Object(v.jsx)("p",{children:"Redemarrage en cours"})})),Object(v.jsxs)("div",{children:[e,Object(v.jsx)(o.a,{children:Object(v.jsx)(l.a,{children:Object(v.jsx)(u.a,{onClick:this.redemarrer,disabled:this.state.attente,children:"Redemarrer"})})})]})}}]),r}(a.a.Component),Oe=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={idmg:""},e.changerChamp=function(t){var r=t.currentTarget,n=r.name,a=r.value;e.setState(Object(_.a)({},n,a))},e.suivant=function(t){console.debug("Props - %O",e.props),e.props.setIdmg(e.state.idmg),e.props.setPage(t)},e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){this.props.rootProps.idmg&&(console.debug("ConfigurerNoeudIdmg IDMG = %s, aller a la page suivante",this.props.rootProps.idmg),this.props.setPage({currentTarget:{value:"ConfigurerNoeud"}}))}},{key:"render",value:function(){return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h2",{children:"Configurer IDMG"}),Object(v.jsx)("p",{children:"Saisir le IDMG pour empecher un tiers de prendre possession du noeud"}),Object(v.jsx)(me,{idmg:this.state.idmg,changerChamp:this.changerChamp}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)(u.a,{onClick:this.suivant,value:"ConfigurerNoeud",children:"Suivant"}),Object(v.jsx)(u.a,{variant:"secondary",children:"Retour"})]})})]})}}]),r}(a.a.Component);function me(e){return Object(v.jsxs)(ue.a,{className:"mb-3",children:[Object(v.jsx)(ue.a.Text,{id:"idmg",children:"IDMG du noeud"}),Object(v.jsx)(de.a,{id:"idmg","aria-describedby":"idmg",name:"idmg",value:e.idmg,onChange:e.changerChamp})]})}var ge=r(235),xe=r.n(ge),ve=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){return Object(N.a)(this,r),t.apply(this,arguments)}return Object(D.a)(r,[{key:"render",value:function(){console.debug("ConfigurerNoeud props : %O",this.props);var e=this.props.typeNoeud;return this.props.rootProps.internetDisponible?Object(v.jsx)(Se,Object(w.a)({},this.props)):"protege"===e?Object(v.jsx)(ke,Object(w.a)({},this.props)):"prive"===e?Object(v.jsx)(Ce,Object(w.a)({},this.props)):"public"===e?Object(v.jsx)(Pe,Object(w.a)({},this.props)):Object(v.jsx)(d.a,{variant:"danger",children:"Type noeud inconnu"})}}]),r}(a.a.Component);function Ce(e){var t=e.idmg;return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h2",{children:"Finaliser la configuration"}),Object(v.jsx)("h3",{children:"Noeud prive"}),Object(v.jsxs)("p",{children:["Idmg : ",t]}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{className:"bouton",children:[Object(v.jsx)(u.a,{onClick:function(t){De(e,{},(function(e){e?console.error("Erreur demarrage installation noeud\n%O",e):setTimeout((function(e){window.location.reload()}),2e3)}))},value:"true",children:"Demarrer installation"}),Object(v.jsx)(u.a,{onClick:e.precedent,value:"false",variant:"secondary",children:"Precedent"})]})})]})}function Pe(e){var t=e.idmg;return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h2",{children:"Finaliser la configuration"}),Object(v.jsx)("h3",{children:"Noeud public"}),Object(v.jsxs)("p",{children:["Idmg : ",t]}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{className:"bouton",children:[Object(v.jsx)(u.a,{onClick:function(t){Ae(e,{},(function(e){e?console.error("Erreur demarrage installation noeud\n%O",e):setTimeout((function(e){window.location.reload()}),2e3)}))},value:"true",children:"Demarrer installation"}),Object(v.jsx)(u.a,{onClick:e.precedent,value:"false",variant:"secondary",children:"Precedent"})]})})]})}function ke(e){var t=e.rootProps.intermediaireCert;return Object(v.jsxs)(O.a,{children:[Object(v.jsx)("h2",{children:"Finaliser la configuration"}),Object(v.jsx)("h3",{children:"Certificat du noeud"}),Object(v.jsx)(ae,{certificat:t}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{className:"bouton",children:[Object(v.jsx)(u.a,{onClick:function(t){we(e,{},(function(e){e?console.error("Erreur demarrage installation noeud\n%O",e):(console.debug("Recu reponse demarrage installation noeud"),setTimeout((function(e){window.location.reload()}),15e3))}))},value:"true",children:"Demarrer installation"}),Object(v.jsx)(u.a,{onClick:e.precedent,value:"false",variant:"secondary",children:"Precedent"})]})})]})}var Se=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={resultatTestAccesUrl:!1,domaineConfigure:!1,certificatRecu:!1,serveurWebRedemarre:!1,erreur:!1,messageErreur:"",stackErreur:""},e.testerAccesUrl=Object(q.a)(Object(L.a)().mark((function t(){var r,n;return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.setState({resultatTestAccesUrl:!1,domaineConfigure:!1,certificatRecu:!1,compteurAttenteCertificatWeb:0,compteurAttenteRedemarrageServeur:0,erreur:!1,messageErreur:"",stackErreur:""}),"/installation/api/info",r=T.a.create({timeout:5e3,httpsAgent:new xe.a.Agent({keepAlive:!0,rejectUnauthorized:!1})}),t.prev=3,t.next=6,r.get("/installation/api/info");case 6:n=t.sent,console.debug("Reponse test\n%O",n),e.setState({resultatTestAccesUrl:!0},(function(){e.configurerDomaine()})),t.next=15;break;case 11:t.prev=11,t.t0=t.catch(3),console.error("Erreur connexion\n%O",t.t0),e.setState({erreur:!0,messageErreur:t.t0.message,stackErreur:t.t0.stack});case 15:case"end":return t.stop()}}),t,null,[[3,11]])}))),e.attendreCertificatWeb=Object(q.a)(Object(L.a)().mark((function t(){return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.debug("Attente certificat web - debut"),!(e.state.compteurAttenteCertificatWeb>25)){t.next=4;break}return e.setState({erreur:!0,messageErreur:"Timeout attente certificat SSL"}),t.abrupt("return");case 4:return console.debug("Attente certificat web"),t.prev=5,t.next=8,T.a.get("/installation/api/etatCertificatWeb");case 8:t.sent.data.pret?(console.debug("Certificat pret"),e.setState({certificatRecu:!0},(function(){setTimeout(e.attendreRedemarrageServeur,15e3)}))):(console.debug("Certificat n'est pas pret"),e.setState({compteurAttenteCertificatWeb:e.state.compteurAttenteCertificatWeb+1}),setTimeout(e.attendreCertificatWeb,5e3)),t.next=16;break;case 12:t.prev=12,t.t0=t.catch(5),console.error("Erreur configuration domaine\n%O",t.t0),e.setState({erreur:!0,messageErreur:t.t0.message,stackErreur:t.t0.stack});case 16:case"end":return t.stop()}}),t,null,[[5,12]])}))),e.attendreRedemarrageServeur=Object(q.a)(Object(L.a)().mark((function t(){return Object(L.a)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(console.debug("Attente redemarrage serveur - debut"),!(e.state.compteurAttenteRedemarrageServeur>10)){t.next=4;break}return e.setState({erreur:!0,messageErreur:"Timeout redemarrage serveur"}),t.abrupt("return");case 4:return console.debug("Attente redemarrage web"),t.prev=5,t.next=8,T.a.get("/installation/api/etatCertificatWeb");case 8:console.debug("Certificat pret"),e.setState({serveurWebRedemarre:!0},(function(){e.configurationCompletee()})),t.next=17;break;case 12:t.prev=12,t.t0=t.catch(5),console.error("Erreur test nouveau certificat serveur\n%O",t.t0),setTimeout(e.attendreRedemarrageServeur,5e3),e.setState({compteurAttenteRedemarrageServeur:e.state.compteurAttenteRedemarrageServeur+1});case 17:case"end":return t.stop()}}),t,null,[[5,12]])}))),e.configurationCompletee=Object(q.a)(Object(L.a)().mark((function e(){return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.debug("Configuration completee");case 1:case"end":return e.stop()}}),e)}))),e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){this.testerAccesUrl()}},{key:"configurerDomaine",value:function(){var e=Object(q.a)(Object(L.a)().mark((function e(){var t,r,n,a=this;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.props.rootProps.infoInternet,console.debug("Configurer le domaine %s",t),r={domaine:t.domaine,modeTest:t.modeTest},"dns_cloudns"===this.props.modeCreation&&(r.modeCreation=t.modeCreation,r.cloudnsSubid=t.cloudnsSubid,r.cloudnsPassword=t.cloudnsPassword);try{n=function(e){if(e)return console.error("Erreur demarrage installation noeud\n%O",e),void a.setState({err:""+e});a.setState({domaineConfigure:!0},(function(){a.attendreCertificatWeb()}))},"protege"===this.props.typeNoeud?we(this.props,r,n):"prive"===this.props.typeNoeud?De(this.props,r,n):"public"===this.props.typeNoeud&&Ae(this.props,r,n)}catch(i){console.error("Erreur configuration domaine\n%O",i),this.setState({erreur:!0,messageErreur:i.message,stackErreur:i.stack})}case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=[],t="";t=this.state.erreur?Object(v.jsx)("i",{className:"fa fa-close fa-2x btn-outline-danger"}):Object(v.jsx)("i",{className:"fa fa-spinner fa-pulse fa-2x fa-fw"},"spinner");var r=Object(v.jsx)("i",{className:"fa fa-check-square fa-2x fa-fw btn-outline-success"},"spinner"),n=this.state.resultatTestAccesUrl?r:t;if(e.push(Object(v.jsxs)("li",{children:["Verifier acces au serveur ",this.props.domaine," ",n]},"1")),this.state.resultatTestAccesUrl){var a=this.state.domaineConfigure?r:t;e.push(Object(v.jsxs)("li",{children:["Configuration du domaine ",a]},"2"))}if(this.state.domaineConfigure){var i=this.state.certificatRecu?r:t;e.push(Object(v.jsxs)("li",{children:["Configuration du certificat SSL ",i]},"3"))}this.state.certificatRecu&&e.push(Object(v.jsxs)("li",{children:["Certificat recu, serveur pret ",r]},"4"));var c="";return this.state.erreur&&(c=Object(v.jsx)(ye,Object(w.a)({domaine:this.props.domaine,retour:this.props.retour,reessayer:this.testerAccesUrl},this.state))),Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h3",{children:"Configuration en cours ..."}),Object(v.jsx)("ol",{children:e}),c]})}}]),r}(a.a.Component);function ye(e){return Object(v.jsxs)(v.Fragment,{children:[Object(v.jsxs)(d.a,{variant:"danger",children:[Object(v.jsx)(d.a.Heading,{children:"Erreur de connexion au domaine demande"}),Object(v.jsxs)("p",{children:["Domaine : ",e.domaine]}),Object(v.jsx)("hr",{}),Object(v.jsx)("p",{children:e.messageErreur})]}),Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)(u.a,{onClick:e.retour,children:"Retour"}),Object(v.jsx)(u.a,{onClick:e.reessayer,children:"Reessayer"})]})})]})}function we(e,t,r){return Ne.apply(this,arguments)}function Ne(){return(Ne=Object(q.a)(Object(L.a)().mark((function e(t,r,n){var a,i,c,s;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.debug("Pour installation, proppys!\n%O",t),a=t.idmg||t.rootProps.idmg,i=t.rootProps.intermediairePem,c=t.rootProps.infoClecertMillegrille.certificat,s=Object(w.a)(Object(w.a)({},r),{},{idmg:a,certificatMillegrille:c,certificatIntermediaire:i,securite:"3.protege"}),t.rootProps.infoInternet&&(s=Object(w.a)(Object(w.a)({},t.rootProps.infoInternet),s)),T.a.post("/installation/api/installer",s).then((function(e){console.debug("Recu reponse demarrage installation noeud\n%O",e),n()})).catch((function(e){console.error("Erreur demarrage installation noeud\n%O",e),n(e)}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function De(e,t,r){return Ie.apply(this,arguments)}function Ie(){return(Ie=Object(q.a)(Object(L.a)().mark((function e(t,r,n){var a,i;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=t.rootProps.infoInternet,i=Object(w.a)(Object(w.a)({},r),{},{idmg:t.idmg,securite:"2.prive"}),console.debug("Transmettre parametres installation noeud prive : %O",i),a&&(i=Object(w.a)(Object(w.a)({},t.rootProps.infoInternet),i)),T.a.post("/installation/api/configurerIdmg",i).then((function(e){console.debug("Recu reponse demarrage installation noeud\n%O",e),n()})).catch((function(e){console.error("Erreur demarrage installation noeud\n%O",e),n(e)}));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Ae(e,t,r){return Me.apply(this,arguments)}function Me(){return(Me=Object(q.a)(Object(L.a)().mark((function e(t,r,n){var a;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=Object(w.a)(Object(w.a)({},r),{},{idmg:t.idmg,securite:"1.public"}),console.debug("Transmettre parametres installation noeud public : %O",a),T.a.post("/installation/api/configurerIdmg",a).then((function(e){console.debug("Recu reponse demarrage installation noeud public\n%O",e),n()})).catch((function(e){console.error("Erreur demarrage installation noeud public\n%O",e),n(e)}));case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var Te=/^((?!-)[A-Za-z0-9-]{1,63}(?<!-)\.)+[A-Za-z]{2,6}$/,Ee={SelectionnerTypeNoeud:R,ChargementClePrivee:K,GenererNouvelleCle:oe,PageConfigurationInternet:pe,ConfigurationCompletee:fe,ConfigurerNoeud:ve,ConfigurerNoeudIdmg:Oe},Re=function(e){Object(I.a)(r,e);var t=Object(A.a)(r);function r(){var e;Object(N.a)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).state={infoMonitorChargee:!1,erreurAcces:!1,domaine:"",typeNoeud:"",page:"SelectionnerTypeNoeud",fqdnDetecte:"",idmg:""},e.setPage=function(t){var r=t.currentTarget.value;console.debug("Page : %s",r),e.setState({page:r})},e.setTypeNoeud=function(t){e.setState({typeNoeud:t.currentTarget.value})},e.setIdmg=function(t){e.setState({idmg:t})},e.afficherPageTypeInstallation=function(t){console.debug("Affiche page, etat %O",e.state),"protege"===e.state.typeNoeud?e.setState({page:"ChargementClePrivee"}):["prive","public"].includes(e.state.typeNoeud)&&e.setState({page:"ConfigurerNoeudIdmg"})},e}return Object(D.a)(r,[{key:"componentDidMount",value:function(){var e=this;T.a.get("/installation/api/info").then((function(t){console.debug("Reponse recue\n%O",t);var r=t.data,n={idmg:r.idmg,domaine:r.domaine,securite:r.securite,noeudId:r.instance_id,certificat:r.certificat,ca:r.ca},a=e.state.typeNoeud;n.securite&&(a=n.securite.split(".")[1]),e.props.rootProps.setInfo(n);var i=window.location.hostname;Te.test(i)||(i=r.fqdn_detecte);var c=e.state.page;n.securite?n.idmg||"3.protege"!==n.securite?n.idmg?n.domaine||(console.debug("Ouvrir configuration domaine internet"),c="PageConfigurationInternet"):c="ConfigurerNoeudIdmg":(console.debug("Ouvrir configuration idmg"),c="ChargementClePrivee"):(console.debug("Ouvrir configuration type noeud"),c="SelectionnerTypeNoeud"),e.setState({infoMonitorChargee:!0,erreurAcces:!1,fqdnDetecte:i,ipDetectee:r.ip_detectee,domaine:r.domaine,page:c,typeNoeud:a})})).catch((function(t){console.error("Erreur lecture info monitor\n%O",t),e.setState({infoMonitorChargee:!1,erreurAcces:!0})}))}},{key:"render",value:function(){if(console.debug("!!! Info monitor state : %O",this.state),this.state.infoMonitorChargee){var e=R;return this.state.page&&(e=Ee[this.state.page]),Object(v.jsx)(e,Object(w.a)({rootProps:this.props.rootProps,setPage:this.setPage,setTypeNoeud:this.setTypeNoeud,setIdmg:this.setIdmg,setInternetDisponible:this.setInternetDisponible,afficherPageTypeInstallation:this.afficherPageTypeInstallation},this.state))}return Object(v.jsx)(Ge,{})}}]),r}(a.a.Component);function Ge(e){return Object(v.jsx)("p",{children:"Chargement en cours"})}function Fe(e){var t=Object(n.useState)(""),r=Object(s.a)(t,2),a=r[0],i=r[1],c=e.rootProps.intermediairePem,o=e.rootProps.infoClecertMillegrille.certificat,l=Object(n.useState)(""),j=Object(s.a)(l,2),p=j[0],b=j[1],h=Object(n.useState)(""),f=Object(s.a)(h,2),O=f[0],m=f[1],g=Object(n.useCallback)((function(e,t){return m({err:e,message:t})}),[m]);return Object(n.useEffect)((function(){(function(){return Le.apply(this,arguments)})().then((function(e){i(e)})).catch((function(e){console.error("Erreur preparation CSR : %O",e),g(""+e)}))}),[i,g]),Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("h2",{children:"Renouveller certificat intermediaire"}),Object(v.jsx)("br",{}),""!==a?Object(v.jsx)(K,{rootProps:e.rootProps,csr:a,cacherBoutons:!0}):Object(v.jsx)("p",{children:"Preparation du CSR en cours ..."}),c?Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("p",{children:"Nouveau certificat intermediaire"}),Object(v.jsx)("pre",{children:c})]}):"",o?Object(v.jsxs)(v.Fragment,{children:[Object(v.jsx)("p",{children:"Nouveau certificat instance"}),Object(v.jsx)("pre",{children:o})]}):"",Object(v.jsx)("br",{}),Object(v.jsx)(u.a,{variant:"secondary",onClick:function(){return e.changerPage("Installation")},children:"Retour"}),Object(v.jsx)(u.a,{disabled:!(c&&o),onClick:function(){return function(e){return qe.apply(this,arguments)}(Object(w.a)(Object(w.a)({},e),{},{erreurCb:g,confirmationCb:b}))},children:"Soumettre"}),Object(v.jsx)("br",{}),Object(v.jsxs)(d.a,{show:""!==p,variant:"success",children:[Object(v.jsx)(d.a.Heading,{children:"Succes"}),Object(v.jsx)("p",{children:p})]}),Object(v.jsxs)(d.a,{show:!!O,variant:"danger",children:[Object(v.jsx)(d.a.Heading,{children:"Erreur"}),Object(v.jsx)("p",{children:O?O.message:""}),Object(v.jsx)("pre",{children:O.err?O.err.stack:""})]})]})}function Le(){return(Le=Object(q.a)(Object(L.a)().mark((function e(){var t;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.debug("Charger csr"),"/installation/api/csr",e.next=4,T.a.get("/installation/api/csr");case 4:if(t=e.sent,console.debug("CSR recu : %O",t),200===t.status){e.next=8;break}throw new Error("Erreur axios code : %s",t.status);case 8:return e.abrupt("return",t.data);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function qe(){return(qe=Object(q.a)(Object(L.a)().mark((function e(t){var r,n,a,i,c,s;return Object(L.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.debug("soumettreIntermediaire proppys!\n%O",t),r=t.confirmationCb,n=t.erreurCb,a=t.rootProps.idmg,i=t.rootProps.intermediairePem,c=t.rootProps.infoClecertMillegrille,s={idmg:a,securite:"3.protege",certificatIntermediaire:i,certificatMillegrille:c.certificat},t.rootProps.infoInternet&&(s=Object(w.a)(Object(w.a)({},t.rootProps.infoInternet),s)),e.next=7,T.a.post("/installation/api/installer",s).then((function(e){console.debug("Configuration appliquee avec succes\n%O",e),r("Configuration appliquee avec succes")})).catch((function(e){throw console.error("Erreur application du certificat/configuration \n%O",e),n(e,"Erreur application du certificat/configuration"),e}));case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var _e=h.b.splitPEMCerts,Ue=h.b.extraireExtensionsMillegrille;function Qe(e){var t=null;e.rootProps.idmgCompte&&(t=Object(v.jsx)(p.a,{value:"idmg:"+e.rootProps.idmg,size:75}));var r=Object(v.jsxs)("div",{children:[Object(v.jsx)("h1",{children:"Installation MilleGrille"}),Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:10,children:Object(v.jsx)("p",{className:"idmg",children:e.rootProps.idmg})}),Object(v.jsx)(l.a,{sm:2,className:"footer-right",children:t})]}),e.affichage]});return Object(v.jsx)(P,{changerPage:e.changerPage,page:r,rootProps:e.rootProps})}function We(e){var t,r,a,i=e.rootProps.info||{},c=i.securite,j=i.domaine,p=i.certificat,h=i.ca,O=Object(n.useState)(),m=Object(s.a)(O,2),g=m[0],x=m[1],C=Object(n.useState)(),P=Object(s.a)(C,2),k=P[0],S=P[1],y=Object(n.useState)(),w=Object(s.a)(y,2),N=w[0],D=w[1],I=Object(n.useState)(),A=Object(s.a)(I,2),M=A[0],T=A[1];Object(n.useEffect)((function(){if(p){console.debug("Lecture du certificat %O",p);var e=p;"string"===typeof p&&(e=_e(p));var t=b.pki.certificateFromPem(e[0]),r=b.pki.certificateFromPem(e[1]);console.debug("Cert : %O, inter : %O",t,r),x(t),S(r);var n=Ue(t);console.debug("Extensions : %O",n),T(n)}}),[p]),Object(n.useEffect)((function(){h&&Object(f.getIdmg)(h).then((function(e){D(e)}))}),[h]),console.debug("Props - %O",e);var E=(new Date).getTime();if(g){var R=g.validity.notAfter.getTime();t=R<E,r=Math.floor(Math.min((R-E)/864e5)),console.debug("Jours expiration : %O",r),r<1&&(r=null)}k&&(a=k.validity.notAfter.getTime()<E);var G=[];G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Idmg calcule"}),Object(v.jsx)(l.a,{className:"idmg",children:N||"N/D"})]},"idmg")),G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Securite"}),Object(v.jsx)(l.a,{children:c})]},"securite")),j&&G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Domaine web"}),Object(v.jsx)(l.a,{children:j})]},"domaineWeb")),M&&(M.roles&&G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Roles"}),Object(v.jsx)(l.a,{children:M.roles.toString()})]},"roles")),M.niveauxSecurite&&G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Exchanges"}),Object(v.jsx)(l.a,{children:M.niveauxSecurite.toString()})]},"securite_liste"))),g&&(G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Instance Id"}),Object(v.jsx)(l.a,{children:g.subject.getField("CN").value})]},"noeudId")),G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Expiration"}),Object(v.jsxs)(l.a,{className:t?"expire":"",children:[g.validity.notAfter.toString()," ",r?"("+r+" jours)":Object(v.jsx)("strong",{children:"Expire aujourd'hui"})]})]},"validity_end")),"3.protege"===c&&G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Expiration intermediaire"}),Object(v.jsx)(l.a,{className:a?"expire":"",children:k.validity.notAfter.toString()})]},"validity_inter_end"))),p&&G.push(Object(v.jsxs)(o.a,{children:[Object(v.jsx)(l.a,{sm:3,children:"Certificat"}),Object(v.jsx)(l.a,{children:Object(v.jsx)("pre",{children:p})})]},"certificat"));var F=null,L="";return g?(F=a?Object(v.jsxs)(d.a,{variant:"danger",children:[Object(v.jsx)(d.a.Heading,{children:"Certificat intermediaire expire"}),Object(v.jsxs)("p",{children:["Le certificat intermediaire est expire. ",Object(v.jsx)("strong",{children:"Action avec cle de MilleGrille requise des que possible."})]})]}):t?Object(v.jsxs)(d.a,{variant:"danger",children:[Object(v.jsx)(d.a.Heading,{children:"Certificat expire"}),Object(v.jsxs)("p",{children:["Le certificat de l'instance est expire. ",Object(v.jsx)("strong",{children:"Action requise"}),"."]})]}):Object(v.jsx)(d.a,{variant:"success",children:"L'instance est initialisee et active."}),L=Object(v.jsx)(o.a,{children:Object(v.jsxs)(l.a,{children:[Object(v.jsx)(u.a,{href:"/millegrilles",children:"Acceder"}),Object(v.jsx)(u.a,{disabled:"3.protege"!==c,variant:"secondary",onClick:function(){return e.changerPage("RenouvellementIntermediaire")},children:"Renouveller"})]})})):F=e.rootProps.idmg?Object(v.jsx)(d.a,{variant:"warning",children:"L'instance est associee a une MilleGrille mais pas encore initialisee."}):Object(v.jsx)(d.a,{variant:"warning",children:"L'instance n'est pas associe a une MilleGrille"}),Object(v.jsxs)("div",{children:[Object(v.jsx)("h2",{children:"Information"}),F,G,L]})}var He=function(e){var t=Object(n.useState)(""),r=Object(s.a)(t,2),a=r[0],i=r[1],c=Object(n.useState)(""),o=Object(s.a)(c,2),l=o[0],u=o[1],d=Object(n.useState)(""),j=Object(s.a)(d,2),p=j[0],b=j[1],h=Object(n.useState)("Installation"),f=Object(s.a)(h,2),O=f[0],m=f[1],g=Object(n.useState)(""),x=Object(s.a)(g,2),C=x[0],P=x[1],k=Object(n.useState)(""),S=Object(s.a)(k,2),y=S[0],w=S[1],N=Object(n.useState)(""),D=Object(s.a)(N,2),I=D[0],A=D[1],M=Object(n.useState)({}),T=Object(s.a)(M,2),E=T[0],R=T[1],G=Object(n.useMemo)((function(){var e=Re;switch(O){case"AfficherInformationNoeud":e=We;break;case"RenouvellementIntermediaire":e=Fe}return e}),[O]),F=Object(n.useCallback)((function(e){e.securite&&e.idmg&&(console.debug("Configuration MilleGrille completee : %O",e),m("AfficherInformationNoeud")),u(e)}),[m,u]),L=Object(n.useCallback)((function(e){P(e),i(e.idmg)}),[P,i]),q={idmg:a,info:l,infoInternet:p,infoClecertMillegrille:C,intermediairePem:y,intermediaireCert:I,manifest:E,setInfo:F,setInfoClecertMillegrille:L,setInfoCertificatNoeudProtege:Object(n.useCallback)((function(e,t){console.debug("Certificat intermediaire PEM\n%s",e),w(e),A(t)}),[w,A]),setInfoInternet:b,setManifest:R},_=Object(v.jsx)(G,{rootProps:q,changerPage:m});return Object(v.jsx)(Qe,{changerPage:m,affichage:_,rootProps:q})};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));r(368),r(369);var Be=r(170),ze=r(142),Ve=r(236),Ye=r(84),Je=r.n(Ye),Ke=(r(370),{fr:r(237),en:r(238)});Be.a.use(Ve.a).use(ze.d).init({resources:Ke,fallbackLng:"fr",keySeparator:".",interpolation:{escapeValue:!1,format:function(e,t,r){return e instanceof Date?Je()(e).locale(r).format(t):isNaN(e)||isNaN(t)?e:Number(e).toFixed(t)}}});Be.a;c.a.render(Object(v.jsx)(a.a.StrictMode,{children:Object(v.jsx)(He,{})}),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))}},[[371,1,2]]]);
//# sourceMappingURL=main.51d844dd.chunk.js.map